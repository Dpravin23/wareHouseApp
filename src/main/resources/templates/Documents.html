<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/">

<head>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
	<link rel="stylesheet" th:href="@{/css/styles.css}">
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>
<body>
<div th:insert="fragments/commonui :: userhead"></div>
<div th:insert="fragments/commonui :: usermenu"> </div>
<div class="container"> 
   <div class="card">
      <div class="card-header bg-primary text-white text-center">
      <h3> DOCUMENTS </h3></div>
   </div>
   <div class="card-body">
   <form id="documentForm" th:action="@{/documents/save}" method="post" enctype="multipart/form-data">
   
   <!-- row1 -->
   <div class="row">
					<div class="col-4">
						<label for="fileId">FILE ID</label>
					</div>
					<div class="col-4">
						<input type="text" id="fileId" name="fileId" class="form-control"/> 
					</div>
					<div class="col-4">
						<span id="fileIdErr"></span>
					</div>
				</div>
				<!-- row2 -->
   <div class="row">
					<div class="col-4">
						<label for="fileOb">Select FILE </label>
					</div>
					<div class="col-4">
						<input type="file" id="fileOb" name="fileOb" class="form-control bg-info text-white" accept=".jpg,.jpeg,.doc,.docx,.zip"/> 
					</div>
					<div class="col-4">
						<span id="fileObErr"></span>
					</div>
				</div>
				<input type=submit value="Upload" class="btn btn-success">
   </form>
   </div>
   <div class="card-body">
 <table class="table">
 <tr>
    <th>FILE ID</th>
    <th>File NAME</th>
    <th>LINK</th>
   </tr>
    <tr th:each="ob:${list}">
      <td th:text="${ob[0]}"/></td>
      <td th:text="${ob[1]}"/></td>
      <td><a th:href="@{/documents/download/{id}(id=${ob[0]})}">Download</a></td>
    </tr>
 </table>
</div>
</div>
<script>
  $(document).ready(function () { 
  $("#fileIdErr").hide();
  $("#fileObErr").hide();
  
  var fileIdErr=false;
  var fileObErr=false;
  
  $("#fileId").keyup(function(){
    validate_fileId();
  });
  
  $('input[type="file"][name="fileOb"]').change(function(){
      validate_fileOb(this.files[0]);
  });
  
     function validate_fileId(){
       var val=$("#fileId").val();
       var exp=/^[1-9][0-9]*$/;
       
       if(val==''){
        $("#fileIdErr").show();
        $("#fileIdErr").html("Enter <b>File Id</b>");
        $("#fileIdErr").css("color","red");
        fileIdErr=false;
       }else if(!exp.test(val)){
        $("#fileIdErr").show();
        $("#fileIdErr").html("Not a valid <b>File Id</b>");
        $("#fileIdErr").css("color","red");
        fileIdErr=false;
       }else {
                         $.ajax({
									
									  url:'validatefileId',
									  data:{"docId":val},
									  success:function(resTxt){
										if(resTxt !="")
										{
											$("#fileIdErr").show();

											$("#fileIdErr").html(resTxt);

											$("#fileIdErr").css('color', 'red');
											fileIdErr = false;
															
										}else{
											$("#fileIdErr").hide();
											 fileIdErr = true;
										}
									  }
									  
								});
                }
        return fileIdErr;
     
      
     }
  function validate_fileOb(ob){
  //here ob contains all file details
   var fname=ob.name;
   var fsize=ob.size;//bytes 1024=1kb
   var fext=fname.substring(fname.lastIndexOf(".")+1);
   var allowedExt =["jpg","jpeg","doc","docx","zip"];
   
   if ($.inArray(fext,allowedExt)==-1){
   $("#fileObErr").show();
        $("#fileObErr").html("Choose a valid<b>File:"+allowedExt+" only</b>");
        $("#fileObErr").css("color","red");
        fileObErr=false;
   }else if(fsize <=1024*2){//min size 2kb
     $("#fileObErr").show();
        $("#fileObErr").html("Size less than 2kb</b>");
        $("#fileObErr").css("color","red");
        fileObErr=false;
   }else if(fsize>1024*1024*100){//10Mb
       $("#fileObErr").show();
        $("#fileObErr").html("<b>Size exceeds 100kb</b>");
        $("#fileObErr").css("color","red");
        fileObErr=false;
   }else{
    $("#fileObErr").hide();
    fileObErr=true;
   }
   return  fileObErr;
   }
  
  function validate_fileObRequired(){
    var val=$("#fileOb").val();
    if(val==''){
        $("#fileObErr").show();
        $("#fileObErr").html("choose <b>one file atleast</b>");
        $("#fileObErr").css("color","red");
        fileObErr=false;
    
    }
   return  fileObErr;
  }
  
  $("#documentForm").submit(function(){
    validate_fileId();
    validate_fileObRequired();
    if(fileIdErr &&  fileObErr)
    return true;
    else 
    return false;
  
  });
  
  });
</script>
</body>
</html>